"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const session = require("express-session");
const passport = require("passport");
const LocalStrategy = require("passport-local");
const compression = require("compression");
const cookieParser = require("cookie-parser");
const AuthFacade = require("./facades/auth-facade");
const GamesFacade = require("./facades/games-facade");
const events_facade_1 = require("./facades/events-facade");
const news_facade_1 = require("./facades/news-facade");
const dbInitializer = require("./repositories/db-initializer");
const path = require("path");
const bodyParser = require("body-parser");
const log4js = require("log4js");
const cors = require("cors");
const app_config_1 = require("./app-config");
const app_security_1 = require("./app-security");
var logger = log4js.getLogger('[ogk] [index]');
var app = express();
var mongodb = require('mongodb'), mongoClient = mongodb.MongoClient, ObjectID = mongodb.ObjectID, // Used in API endpoints
db; // We'll initialize connection below
app.use(bodyParser.json());
app.set('port', process.env.PORT || 8080);
// SECURITY CONFIGURATION
// =============================================================================
app.use(cors()); // CORS (Cross-Origin Resource Sharing) headers to support Cross-site HTTP requests
app.use((req, res, next) => {
    if (app_config_1.default.isDev) {
        var originHeader = req.get('origin');
        if (originHeader) {
            var matches = originHeader.match(/^((http|https):\/\/localhost:([0-9]{4}))(.*)/);
            if (matches && matches.length > 1) {
                res.header('Access-Control-Allow-Credentials', 'true');
                res.header("Access-Control-Allow-Origin", matches[1]);
                res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
                res.header("Access-Control-Allow-Methods", "PUT, POST, GET, OPTIONS, DELETE, PATCH");
            }
        }
    }
    next();
});
let sessionCookieConfig = {
    maxAge: 3600000 * 24 * 21 // 21 days
};
if (app_config_1.default.isDev) {
    logger.warn("Local development mode");
}
else {
    sessionCookieConfig.secure = true;
    app.use(app_security_1.default.forceSsl);
}
app.use(cookieParser());
app.use(session({
    secret: app_config_1.default.SESSION_SECRET,
    proxy: true,
    cookie: sessionCookieConfig,
    saveUninitialized: true,
    resave: true
}));
app.use(passport.initialize());
app.use(passport.session());
app.use(compression());
passport.use('local-signup', new LocalStrategy({
    // by default, local strategy uses username and password, we will override with email
    usernameField: 'email',
    passwordField: 'password',
    passReqToCallback: true // allows us to pass back the entire request to the callback
}, function (req, email, password, done) {
    // asynchronous
    // User.findOne wont fire unless data is sent back
    process.nextTick(function () {
        // find a user whose email is the same as the forms email
        // we are checking to see if the user trying to login already exists
        return done(null, {
            email: "developer@ogk.be",
            firstName: "developmer"
        });
    });
}));
passport.serializeUser(function (user, done) {
    done(null, user); // TODO: Retrieve user data from database instead of saving to session
});
passport.deserializeUser(function (user, done) {
    done(null, user);
});
app.post('/login', passport.authenticate('local', { failureRedirect: '/login' }), function (req, res) {
    res.redirect('/');
});
// APPLICATION
// =============================================================================
app.use(express.static(path.join(__dirname, '/public')));
// Error handler
app.use(function (err, req, res, next) {
    res.status(err.status || 500);
    res.json({
        message: err.message,
        error: (app.get('env') === 'development' ? err : {})
    });
    next(err);
});
// Start application and initialize DB Connection
app.listen(app.get('port'), function () {
    dbInitializer.initConnection()
        .then(() => {
        logger.info(`OGK is now running on port ${app.get('port')}!`);
    });
});
process.on('SIGINT', function () {
    dbInitializer.closeDBConnections();
    process.exit(0);
});
// ROUTES FOR OUR API
// =============================================================================
// middleware to use for all requests
app.all('/api*', AuthFacade.requireAuthentication);
app.use(function (req, res, next) {
    // do logging
    logger.info(req.method + " " + req.url);
    next();
});
// more routes for our API will happen here
app.use('/api/events', events_facade_1.EventsFacade.router);
app.use('/api/games', GamesFacade.router);
app.use('/api/news', news_facade_1.NewsFacade.router);

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxRQUFRLEVBQUU7SUFDakIsYUFBYSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDbkMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNwQixDQUFDLENBQUMsQ0FBQztBQUdILHFCQUFxQjtBQUNyQixnRkFBZ0Y7QUFDaEYscUNBQXFDO0FBQ3JDLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ25ELEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUk7SUFDM0IsYUFBYTtJQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hDLElBQUksRUFBRSxDQUFDO0FBQ1gsQ0FBQyxDQUFDLENBQUM7QUFFSCwyQ0FBMkM7QUFDM0MsR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsNEJBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM1QyxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDMUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsd0JBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSBcImV4cHJlc3NcIjtcclxuaW1wb3J0ICogYXMgc2Vzc2lvbiBmcm9tICdleHByZXNzLXNlc3Npb24nO1xyXG5pbXBvcnQgKiBhcyBwYXNzcG9ydCBmcm9tICdwYXNzcG9ydCc7XHJcbmltcG9ydCAqIGFzIExvY2FsU3RyYXRlZ3kgZnJvbSAncGFzc3BvcnQtbG9jYWwnO1xyXG5pbXBvcnQgKiBhcyBjb21wcmVzc2lvbiBmcm9tICdjb21wcmVzc2lvbic7XHJcbmltcG9ydCAqIGFzIGNvb2tpZVBhcnNlciBmcm9tICdjb29raWUtcGFyc2VyJztcclxuaW1wb3J0ICogYXMgQXV0aEZhY2FkZSBmcm9tICcuL2ZhY2FkZXMvYXV0aC1mYWNhZGUnO1xyXG5pbXBvcnQgKiBhcyBHYW1lc0ZhY2FkZSBmcm9tICcuL2ZhY2FkZXMvZ2FtZXMtZmFjYWRlJztcclxuaW1wb3J0IHtFdmVudHNGYWNhZGV9IGZyb20gJy4vZmFjYWRlcy9ldmVudHMtZmFjYWRlJztcclxuaW1wb3J0IHtOZXdzRmFjYWRlfSBmcm9tICcuL2ZhY2FkZXMvbmV3cy1mYWNhZGUnO1xyXG5pbXBvcnQgKiBhcyBkYkluaXRpYWxpemVyIGZyb20gJy4vcmVwb3NpdG9yaWVzL2RiLWluaXRpYWxpemVyJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0ICogYXMgYm9keVBhcnNlciBmcm9tICdib2R5LXBhcnNlcic7XHJcbmltcG9ydCAqIGFzIGxvZzRqcyBmcm9tICdsb2c0anMnO1xyXG5pbXBvcnQgKiBhcyBjb3JzIGZyb20gJ2NvcnMnO1xyXG5pbXBvcnQgYXBwQ29uZmlnIGZyb20gJy4vYXBwLWNvbmZpZyc7XHJcbmltcG9ydCBhcHBTZWN1cml0eSBmcm9tICcuL2FwcC1zZWN1cml0eSc7XHJcblxyXG52YXIgbG9nZ2VyID0gbG9nNGpzLmdldExvZ2dlcignW29na10gW2luZGV4XScpO1xyXG52YXIgYXBwID0gZXhwcmVzcygpO1xyXG52YXIgbW9uZ29kYiA9IHJlcXVpcmUoJ21vbmdvZGInKSxcclxuICAgIG1vbmdvQ2xpZW50ID0gbW9uZ29kYi5Nb25nb0NsaWVudCxcclxuICAgIE9iamVjdElEID0gbW9uZ29kYi5PYmplY3RJRCwgLy8gVXNlZCBpbiBBUEkgZW5kcG9pbnRzXHJcbiAgICBkYjsgLy8gV2UnbGwgaW5pdGlhbGl6ZSBjb25uZWN0aW9uIGJlbG93XHJcblxyXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKTtcclxuYXBwLnNldCgncG9ydCcsIHByb2Nlc3MuZW52LlBPUlQgfHwgODA4MCk7XHJcblxyXG5cclxuLy8gU0VDVVJJVFkgQ09ORklHVVJBVElPTlxyXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG5hcHAudXNlKGNvcnMoKSk7IC8vIENPUlMgKENyb3NzLU9yaWdpbiBSZXNvdXJjZSBTaGFyaW5nKSBoZWFkZXJzIHRvIHN1cHBvcnQgQ3Jvc3Mtc2l0ZSBIVFRQIHJlcXVlc3RzXHJcbmFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICBpZiAoYXBwQ29uZmlnLmlzRGV2KSB7XHJcbiAgICAgICAgdmFyIG9yaWdpbkhlYWRlciA9IHJlcS5nZXQoJ29yaWdpbicpO1xyXG4gICAgICAgIGlmIChvcmlnaW5IZWFkZXIpIHtcclxuICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBvcmlnaW5IZWFkZXIubWF0Y2goL14oKGh0dHB8aHR0cHMpOlxcL1xcL2xvY2FsaG9zdDooWzAtOV17NH0pKSguKikvKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICAgICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctQ3JlZGVudGlhbHMnLCAndHJ1ZScpO1xyXG4gICAgICAgICAgICAgICAgcmVzLmhlYWRlcihcIkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpblwiLCBtYXRjaGVzWzFdKTtcclxuICAgICAgICAgICAgICAgIHJlcy5oZWFkZXIoXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzXCIsIFwiT3JpZ2luLCBYLVJlcXVlc3RlZC1XaXRoLCBDb250ZW50LVR5cGUsIEFjY2VwdFwiKTtcclxuICAgICAgICAgICAgICAgIHJlcy5oZWFkZXIoXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzXCIsIFwiUFVULCBQT1NULCBHRVQsIE9QVElPTlMsIERFTEVURSwgUEFUQ0hcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBuZXh0KCk7XHJcbn0pO1xyXG5sZXQgc2Vzc2lvbkNvb2tpZUNvbmZpZzogYW55ID0ge1xyXG4gICAgbWF4QWdlOiAzNjAwMDAwICogMjQgKiAyMSAvLyAyMSBkYXlzXHJcbn07XHJcbmlmIChhcHBDb25maWcuaXNEZXYpIHtcclxuICAgIGxvZ2dlci53YXJuKFwiTG9jYWwgZGV2ZWxvcG1lbnQgbW9kZVwiKTtcclxufSBlbHNlIHtcclxuICAgIHNlc3Npb25Db29raWVDb25maWcuc2VjdXJlID0gdHJ1ZTtcclxuICAgIGFwcC51c2UoYXBwU2VjdXJpdHkuZm9yY2VTc2wpO1xyXG59XHJcblxyXG5hcHAudXNlKGNvb2tpZVBhcnNlcigpKTtcclxuYXBwLnVzZShzZXNzaW9uKHtcclxuICAgIHNlY3JldDogYXBwQ29uZmlnLlNFU1NJT05fU0VDUkVULFxyXG4gICAgcHJveHk6IHRydWUsXHJcbiAgICBjb29raWU6IHNlc3Npb25Db29raWVDb25maWcsXHJcbiAgICBzYXZlVW5pbml0aWFsaXplZDogdHJ1ZSxcclxuICAgIHJlc2F2ZTogdHJ1ZVxyXG59KSk7XHJcblxyXG5hcHAudXNlKHBhc3Nwb3J0LmluaXRpYWxpemUoKSk7XHJcbmFwcC51c2UocGFzc3BvcnQuc2Vzc2lvbigpKTtcclxuYXBwLnVzZShjb21wcmVzc2lvbigpKTtcclxucGFzc3BvcnQudXNlKCdsb2NhbC1zaWdudXAnLCBuZXcgTG9jYWxTdHJhdGVneSh7XHJcbiAgICAgICAgLy8gYnkgZGVmYXVsdCwgbG9jYWwgc3RyYXRlZ3kgdXNlcyB1c2VybmFtZSBhbmQgcGFzc3dvcmQsIHdlIHdpbGwgb3ZlcnJpZGUgd2l0aCBlbWFpbFxyXG4gICAgICAgIHVzZXJuYW1lRmllbGQgOiAnZW1haWwnLFxyXG4gICAgICAgIHBhc3N3b3JkRmllbGQgOiAncGFzc3dvcmQnLFxyXG4gICAgICAgIHBhc3NSZXFUb0NhbGxiYWNrIDogdHJ1ZSAvLyBhbGxvd3MgdXMgdG8gcGFzcyBiYWNrIHRoZSBlbnRpcmUgcmVxdWVzdCB0byB0aGUgY2FsbGJhY2tcclxuICAgIH0sIGZ1bmN0aW9uKHJlcSwgZW1haWwsIHBhc3N3b3JkLCBkb25lKSB7XHJcbiAgICAgICAgLy8gYXN5bmNocm9ub3VzXHJcbiAgICAgICAgLy8gVXNlci5maW5kT25lIHdvbnQgZmlyZSB1bmxlc3MgZGF0YSBpcyBzZW50IGJhY2tcclxuICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge1xyXG5cclxuICAgICAgICAvLyBmaW5kIGEgdXNlciB3aG9zZSBlbWFpbCBpcyB0aGUgc2FtZSBhcyB0aGUgZm9ybXMgZW1haWxcclxuICAgICAgICAvLyB3ZSBhcmUgY2hlY2tpbmcgdG8gc2VlIGlmIHRoZSB1c2VyIHRyeWluZyB0byBsb2dpbiBhbHJlYWR5IGV4aXN0c1xyXG5cclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4gZG9uZShudWxsLCB7XHJcbiAgICAgICAgICAgIGVtYWlsOiBcImRldmVsb3BlckBvZ2suYmVcIixcclxuICAgICAgICAgICAgZmlyc3ROYW1lOiBcImRldmVsb3BtZXJcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn0pKTtcclxuXHJcbnBhc3Nwb3J0LnNlcmlhbGl6ZVVzZXIoZnVuY3Rpb24gKHVzZXIsIGRvbmUpIHtcclxuICAgIGRvbmUobnVsbCwgdXNlcik7IC8vIFRPRE86IFJldHJpZXZlIHVzZXIgZGF0YSBmcm9tIGRhdGFiYXNlIGluc3RlYWQgb2Ygc2F2aW5nIHRvIHNlc3Npb25cclxufSk7XHJcblxyXG5wYXNzcG9ydC5kZXNlcmlhbGl6ZVVzZXIoZnVuY3Rpb24gKHVzZXIsIGRvbmUpIHtcclxuICAgIGRvbmUobnVsbCwgdXNlcik7XHJcbn0pO1xyXG5cclxuYXBwLnBvc3QoJy9sb2dpbicsIFxyXG4gIHBhc3Nwb3J0LmF1dGhlbnRpY2F0ZSgnbG9jYWwnLCB7IGZhaWx1cmVSZWRpcmVjdDogJy9sb2dpbicgfSksXHJcbiAgZnVuY3Rpb24ocmVxLCByZXMpIHtcclxuICAgIHJlcy5yZWRpcmVjdCgnLycpO1xyXG4gIH0pO1xyXG5cclxuLy8gQVBQTElDQVRJT05cclxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuYXBwLnVzZShleHByZXNzLnN0YXRpYyhwYXRoLmpvaW4oX19kaXJuYW1lLCAnL3B1YmxpYycpKSk7XHJcblxyXG4vLyBFcnJvciBoYW5kbGVyXHJcbmFwcC51c2UoZnVuY3Rpb24oZXJyLCByZXEsIHJlcywgbmV4dCkge1xyXG4gICAgcmVzLnN0YXR1cyhlcnIuc3RhdHVzIHx8IDUwMCk7XHJcbiAgICByZXMuanNvbih7XHJcbiAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXHJcbiAgICAgICAgZXJyb3I6IChhcHAuZ2V0KCdlbnYnKSA9PT0gJ2RldmVsb3BtZW50JyA/IGVyciA6IHt9KVxyXG4gICAgfSk7XHJcbiAgICBuZXh0KGVycik7XHJcbn0pO1xyXG5cclxuLy8gU3RhcnQgYXBwbGljYXRpb24gYW5kIGluaXRpYWxpemUgREIgQ29ubmVjdGlvblxyXG5hcHAubGlzdGVuKGFwcC5nZXQoJ3BvcnQnKSwgZnVuY3Rpb24gKCkge1xyXG4gICAgZGJJbml0aWFsaXplci5pbml0Q29ubmVjdGlvbigpXHJcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhgT0dLIGlzIG5vdyBydW5uaW5nIG9uIHBvcnQgJHthcHAuZ2V0KCdwb3J0Jyl9IWApO1xyXG4gICAgICAgIH0pO1xyXG59KTtcclxuXHJcbnByb2Nlc3Mub24oJ1NJR0lOVCcsIGZ1bmN0aW9uICgpIHtcclxuICAgIGRiSW5pdGlhbGl6ZXIuY2xvc2VEQkNvbm5lY3Rpb25zKCk7XHJcbiAgICBwcm9jZXNzLmV4aXQoMCk7XHJcbn0pO1xyXG5cclxuXHJcbi8vIFJPVVRFUyBGT1IgT1VSIEFQSVxyXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4vLyBtaWRkbGV3YXJlIHRvIHVzZSBmb3IgYWxsIHJlcXVlc3RzXHJcbmFwcC5hbGwoJy9hcGkqJywgQXV0aEZhY2FkZS5yZXF1aXJlQXV0aGVudGljYXRpb24pO1xyXG5hcHAudXNlKGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICAvLyBkbyBsb2dnaW5nXHJcbiAgICBsb2dnZXIuaW5mbyhyZXEubWV0aG9kICsgXCIgXCIgKyByZXEudXJsKTtcclxuICAgIG5leHQoKTsgXHJcbn0pO1xyXG5cclxuLy8gbW9yZSByb3V0ZXMgZm9yIG91ciBBUEkgd2lsbCBoYXBwZW4gaGVyZVxyXG5hcHAudXNlKCcvYXBpL2V2ZW50cycsIEV2ZW50c0ZhY2FkZS5yb3V0ZXIpO1xyXG5hcHAudXNlKCcvYXBpL2dhbWVzJywgR2FtZXNGYWNhZGUucm91dGVyKTtcclxuYXBwLnVzZSgnL2FwaS9uZXdzJywgTmV3c0ZhY2FkZS5yb3V0ZXIpO1xyXG5cclxuIl0sInNvdXJjZVJvb3QiOiIifQ==
